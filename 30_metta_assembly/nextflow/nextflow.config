// ============================================================================
// METTA Assembly Pipeline - Nextflow Configuration
// ============================================================================

// Working directory for intermediate files (defaults to pipeline dir)
workDir = "${projectDir}/work"

// Default parameters (override via CLI: --param_name value)
params {
    // Help
    help            = false

    // Required
    input           = null      // Directory containing paired-end *_R1_*.fastq.gz reads

    // Output
    outdir          = "results"
    store_dir       = null      // Persistent cache dir (opt-in); when set, storeDir skips completed processes

    // Mode
    coassembly      = false     // Per-sample assembly by default; true = co-assembly of all samples

    // Preprocessing
    min_readlen     = 70        // bbduk minlen for adapter trimming and quality trimming

    // Normalization
    run_normalize   = true      // bbnorm coverage normalization before assembly

    // Assembly (which assemblers to run)
    run_tadpole     = true      // Run Tadpole assembler
    run_megahit     = true      // Run Megahit assembler
    run_spades      = true      // Run SPAdes assembler
    run_metaspades  = true      // Run metaSPAdes assembler

    // Deduplication
    dedupe_identity = 98        // Final deduplication threshold (cascade: 100 -> 99 -> this)

    // Binning
    metabat_min_cls = 2000      // MetaBAT2 --minClsSize

    // Resources (defaults; override with profiles)
    assembly_cpus   = 24
    assembly_memory = '250 GB'

    // SLURM
    slurm_account   = 'def-rec3141'  // SLURM --account
    conda_path      = null           // Path to conda/mamba bin/ dir (for SLURM beforeScript)
}

// ============================================================================
// Conda configuration
// ============================================================================

conda {
    enabled    = true
    cacheDir   = "${projectDir}/conda-envs"
    useMamba   = true
    createTimeout = '60 min'
}

// ============================================================================
// Process resource labels
// ============================================================================

process {
    fair = true

    withLabel: 'process_low' {
        cpus   = 2
        memory = 4.GB
        time   = 1.h
    }
    withLabel: 'process_medium' {
        cpus   = 8
        memory = 24.GB
        time   = 4.h
    }
    withLabel: 'process_high' {
        cpus   = { [params.assembly_cpus as int, Runtime.runtime.availableProcessors()].min() }
        memory = { "${params.assembly_memory}" as nextflow.util.MemoryUnit }
        time   = 24.h
    }

    errorStrategy = { task.attempt <= task.maxRetries ? 'retry' : 'ignore' }
    maxRetries    = 1
}

// ============================================================================
// Profiles
// ============================================================================

profiles {

    standard {
        process.executor = 'local'
    }

    test {
        params {
            outdir          = "test_results"
            metabat_min_cls = 1000
            assembly_cpus   = 4
            assembly_memory = '8 GB'
        }
        process {
            withLabel: 'process_high' {
                cpus   = 4
                memory = 8.GB
                time   = 2.h
            }
        }
    }

    slurm {
        process.executor = 'slurm'
        process.queue    = 'default'
        process.clusterOptions = "--account=${params.slurm_account}"

        // SLURM jobs get a minimal environment (no .bashrc).
        // Ensure conda/mamba is on PATH so Nextflow can activate prefix envs.
        process.beforeScript = params.conda_path ? "export PATH=${params.conda_path}:\$PATH" : ''

        process {
            withLabel: 'process_low' {
                cpus   = 2
                memory = 4.GB
                time   = 1.h
            }
            withLabel: 'process_medium' {
                cpus   = 8
                memory = 24.GB
                time   = 4.h
            }
            withLabel: 'process_high' {
                cpus   = { params.assembly_cpus as int }
                memory = { "${params.assembly_memory}" as nextflow.util.MemoryUnit }
                time   = 24.h
            }
        }
    }
}

// ============================================================================
// Reports and tracing
// ============================================================================

timeline {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/timeline.html"
    overwrite = true
}

report {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/report.html"
    overwrite = true
}

trace {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/trace.txt"
    overwrite = true
    fields    = 'task_id,hash,native_id,process,tag,name,status,exit,submit,start,complete,duration,realtime,%cpu,%mem,rss,peak_rss'
}

dag {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/dag.html"
    overwrite = true
}

// ============================================================================
// Manifest
// ============================================================================

manifest {
    name            = 'metta-assembly'
    author          = 'Dana Pipeline'
    description     = 'Illumina metagenomic assembly pipeline (BBTools + multi-assembler + MetaBAT2)'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version         = '1.0.0'
}
