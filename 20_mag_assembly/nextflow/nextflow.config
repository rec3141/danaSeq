// ============================================================================
// Dana MAG Assembly Pipeline - Nextflow Configuration
// ============================================================================

// Default parameters (override via CLI: --param_name value)
params {
    // Help
    help            = false

    // Required
    input           = null      // Directory containing *.fastq.gz reads

    // Output
    outdir          = "results"

    // Assembly
    min_overlap     = 1000          // Flye --min-overlap
    polish          = true          // Flye polishing iterations; false sets --iterations 0
    dedupe          = false         // BBDuk deduplication before assembly
    filtlong_size   = null          // Filtlong -t (e.g. "40000000000"); null = skip

    // Binning
    run_semibin     = true          // Include SemiBin2 in consensus
    run_maxbin      = true          // Include MaxBin2 in consensus
    run_lorbin      = true          // Include LorBin in consensus (deep learning, long-read)
    run_comebin     = true          // Include COMEBin in consensus (contrastive learning)
    metabat_min_cls = 50000         // MetaBAT2 --minClsSize
    lorbin_min_length = 80000       // LorBin --bin_length minimum

    // Annotation
    run_prokka      = true          // Run Prokka gene annotation on co-assembly

    // Taxonomy
    run_kaiju       = true          // Run Kaiju protein-level taxonomy (requires Prokka + kaiju_db)
    kaiju_db        = null          // Path to Kaiju database (contains *.fmi, nodes.dmp, names.dmp)

    // Mobile genetic elements
    run_genomad     = true          // Run geNomad virus + plasmid detection
    genomad_db      = null          // Path to geNomad database; null = skip geNomad
    run_checkv      = true          // Run CheckV viral quality assessment (requires geNomad)
    checkv_db       = null          // Path to CheckV database; null = skip CheckV
    run_integronfinder = true       // Run IntegronFinder integron detection
    run_islandpath  = true          // Run IslandPath-DIMOB genomic island detection (requires Prokka)
    run_macsyfinder = true          // Run MacSyFinder secretion/conjugation detection (requires Prokka)
    macsyfinder_models = null       // Path to MacSyFinder models dir (TXSScan + CONJScan); null = skip
    run_defensefinder = true        // Run DefenseFinder anti-phage defense system detection (requires Prokka)
    defensefinder_models = null     // Path to DefenseFinder models dir; null = auto-download

    // Quality assessment
    checkm2_db      = null          // Path to CheckM2 DIAMOND db; null = skip CheckM2

    // NCLB bin refinement (requires nclb_dir)
    run_nclb        = false         // Run NCLB bin refinement after DAS_Tool consensus
    nclb_dir        = null          // Path to NCLB repository (contains bin/, lib/, envs/)
    nclb_base_url   = null          // LLM server URL for conversations (default: http://localhost:1234/v1)
    nclb_model      = null          // LLM model name (default: auto-detect from server)
    nclb_with_ani   = false         // Run minimap2 ANI during Elder investigations

    // Resources (defaults; override with profiles)
    assembly_cpus   = 24
    assembly_memory = '64 GB'
}

// ============================================================================
// Conda configuration
// ============================================================================

conda {
    enabled    = true
    cacheDir   = "${projectDir}/conda-envs"
    useMamba   = true
    createTimeout = '60 min'
}


// ============================================================================
// Process resource labels
// ============================================================================

process {
    fair = true

    withLabel: 'process_low' {
        cpus   = 2
        memory = 4.GB
        time   = 1.h
    }
    withLabel: 'process_medium' {
        cpus   = 8
        memory = 16.GB
        time   = 4.h
    }
    withLabel: 'process_high' {
        cpus   = { params.assembly_cpus }
        memory = { params.assembly_memory }
        time   = 24.h
    }

    errorStrategy = { task.exitStatus in [1,143,137,104,134,139] ? 'retry' : 'ignore' }
    maxRetries    = 1
}

// ============================================================================
// Profiles
// ============================================================================

profiles {

    standard {
        process.executor = 'local'
    }

    test {
        params {
            outdir        = "test_results"
            min_overlap   = 1000       // Flye minimum is 1000
            metabat_min_cls = 10000
            assembly_cpus   = 4
            assembly_memory = '8 GB'
        }
        process {
            withLabel: 'process_high' {
                cpus   = 4
                memory = 8.GB
                time   = 2.h
            }
        }
    }

    shipboard {
        process.executor = 'local'
        executor {
            cpus   = 32
            memory = '256 GB'
        }
        params {
            assembly_cpus   = 32
            assembly_memory = '128 GB'
        }
    }
}

// ============================================================================
// Reports and tracing
// ============================================================================

timeline {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/timeline.html"
    overwrite = true
}

report {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/report.html"
    overwrite = true
}

trace {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/trace.txt"
    overwrite = true
    fields    = 'task_id,hash,native_id,process,tag,name,status,exit,submit,start,complete,duration,realtime,%cpu,%mem,rss,peak_rss'
}

dag {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/dag.html"
    overwrite = true
}

// ============================================================================
// Manifest
// ============================================================================

manifest {
    name            = 'dana-mag-assembly'
    author          = 'Dana Pipeline'
    description     = 'MAG assembly and binning pipeline for Nanopore metagenomics'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version         = '1.0.0'
}
