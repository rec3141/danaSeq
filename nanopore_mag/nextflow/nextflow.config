// ============================================================================
// Dana MAG Assembly Pipeline - Nextflow Configuration
// ============================================================================

// Default parameters (override via CLI: --param_name value)
params {
    // Help
    help            = false

    // Required
    input           = null      // Directory containing *.fastq.gz reads

    // Output
    outdir          = "results"
    store_dir       = null      // Persistent cache dir (opt-in); when set, storeDir skips completed processes

    // Assembly
    min_overlap     = 1000          // Flye --min-overlap
    polish          = true          // Flye polishing iterations; false sets --iterations 0
    dedupe          = false         // BBDuk deduplication before assembly
    filtlong_size   = null          // Filtlong -t (e.g. "40000000000"); null = skip

    // Binning
    run_semibin     = true          // Include SemiBin2 in consensus
    run_maxbin      = true          // Include MaxBin2 in consensus
    run_lorbin      = true          // Include LorBin in consensus (deep learning, long-read)
    run_comebin     = true          // Include COMEBin in consensus (contrastive learning)
    metabat_min_cls = 50000         // MetaBAT2 --minClsSize
    lorbin_min_length = 80000       // LorBin --bin_length minimum

    // Annotation
    run_prokka      = true          // (deprecated) Run Prokka — use --annotator instead
    run_bakta       = false         // (deprecated) Run Bakta — use --annotator instead
    annotator       = null          // Preferred: 'prokka', 'bakta', or 'none'. Overrides run_prokka/run_bakta
    bakta_db        = null          // Path to Bakta full database (used by BAKTA_EXTRA)
    bakta_light_db  = null          // Path to Bakta light database (used by BAKTA_BASIC)
    bakta_extra      = false         // Also run BAKTA_EXTRA annotation (ncRNA/tRNA/CRISPR — slow)

    // Taxonomy
    run_kaiju       = true          // Run Kaiju protein-level taxonomy (requires Prokka + kaiju_db)
    kaiju_db        = null          // Path to Kaiju database (contains *.fmi, nodes.dmp, names.dmp)
    run_kraken2     = false         // Run Kraken2 k-mer taxonomy on contigs (no annotation needed)
    kraken2_db      = null          // Path to Kraken2 database (hash.k2d + nodes.dmp + names.dmp)
    kraken2_confidence = 0.0        // Kraken2 confidence threshold (0.0 = any matching k-mer; raise for stricter)
    run_sendsketch  = false         // Run BBSketch/sendsketch GTDB taxonomy (requires TaxServer)
    sendsketch_address = null       // BBSketch TaxServer URL (e.g. http://host:3068/sketch); null = skip
    run_rrna        = false         // Run barrnap + vsearch rRNA gene classification
    silva_ssu_db    = null          // Path to SILVA SSU NR99 FASTA (DNA, U→T converted); null = skip
    silva_lsu_db    = null          // Path to SILVA LSU NR99 FASTA (optional); null = skip LSU
    rrna_min_identity = 0.80        // Minimum vsearch identity for rRNA classification

    // Mobile genetic elements
    run_genomad     = true          // Run geNomad virus + plasmid detection
    genomad_db      = null          // Path to geNomad database; null = skip geNomad
    run_checkv      = true          // Run CheckV viral quality assessment (requires geNomad)
    checkv_db       = null          // Path to CheckV database; null = skip CheckV
    run_integronfinder = true       // Run IntegronFinder integron detection
    run_islandpath  = true          // Run IslandPath-DIMOB genomic island detection (requires Prokka)
    islandpath_hmm_db = null        // Path to IslandPath HMM profiles; null = conda env's bundled copy
    run_macsyfinder = true          // Run MacSyFinder secretion/conjugation detection (requires Prokka)
    macsyfinder_models = null       // Path to MacSyFinder models dir (TXSScan + CONJScan); null = skip
    run_defensefinder = true        // Run DefenseFinder anti-phage defense system detection (requires Prokka)
    defensefinder_models = null     // Path to DefenseFinder models dir; null = auto-download

    // Metabolic profiling
    run_metabolism   = false         // Run metabolic profiling (KofamScan + eggNOG + dbCAN)
    kofam_db         = null          // Path to KOfam profiles dir (contains profiles/ + ko_list)
    eggnog_db        = null          // Path to eggNOG-mapper database dir
    dbcan_db         = null          // Path to dbCAN database dir

    // Eukaryotic analysis
    run_eukaryotic   = false         // Enable eukaryotic contig classification (Tiara + Whokaryote)
    tiara_min_len    = 3000          // Minimum contig length for Tiara (bp)
    whokaryote_min_len = 5000        // Minimum contig length for Whokaryote (bp)
    run_metaeuk      = false         // Run MetaEuk eukaryotic gene prediction
    metaeuk_db       = null          // Path to MetaEuk protein reference database (MMseqs2 format)
    metaeuk_mem_limit = '50G'        // MetaEuk --split-memory-limit (trades RAM for runtime)
    metaeuk_min_length = 20          // MetaEuk --min-length (minimum codons per fragment)
    metaeuk_max_intron = 10000       // MetaEuk --max-intron (max intron length in bp)
    run_marferret    = false         // Run DIAMOND blastp against MarFERReT (requires MetaEuk proteins)
    marferret_db     = null          // Path to MarFERReT database dir (contains .dmnd + .taxonomies.tab.gz + .best_pfam_annotations.csv.gz)

    // Quality assessment
    checkm2_db      = null          // Path to CheckM2 DIAMOND db; null = skip CheckM2

    // NCLB bin refinement (requires nclb_dir)
    run_nclb        = false         // Run NCLB bin refinement after DAS_Tool consensus
    nclb_dir        = null          // Path to NCLB repository (contains bin/, lib/, envs/)
    nclb_base_url   = null          // LLM server URL for conversations (default: http://localhost:1234/v1)
    nclb_model      = null          // LLM model name (default: auto-detect from server)
    nclb_with_ani   = false         // Run minimap2 ANI during Elder investigations

    // Viz dashboard
    run_viz         = true          // Build viz dashboard (preprocess + static site) at end of pipeline

    // Resources (defaults; override with profiles)
    assembly_cpus   = 16
    assembly_memory = '60 GB'
}

// ============================================================================
// Conda configuration
// ============================================================================

conda {
    enabled    = true
    cacheDir   = "${projectDir}/conda-envs"
    useMamba   = true
    createTimeout = '60 min'
}


// ============================================================================
// Process resource labels
// ============================================================================

process {
    fair = true

    withLabel: 'process_low' {
        cpus   = 2
        memory = 4.GB
        time   = 1.h
    }
    withLabel: 'process_medium' {
        cpus   = 8
        memory = 24.GB
        time   = 4.h
    }
    withLabel: 'process_high' {
        cpus   = { params.assembly_cpus }
        memory = { params.assembly_memory }
        time   = 24.h
    }
    withLabel: 'process_kraken' {
        cpus   = 8
        memory = { params.assembly_memory }
        time   = 4.h
    }

    errorStrategy = { task.attempt <= maxRetries ? 'retry' : 'ignore' }
    maxRetries    = 1
}

// ============================================================================
// Profiles
// ============================================================================

profiles {

    standard {
        process.executor = 'local'
    }

    test {
        params {
            outdir        = "test_results"
            min_overlap   = 1000       // Flye minimum is 1000
            metabat_min_cls = 10000
            assembly_cpus   = 4
            assembly_memory = '8 GB'
        }
        process {
            withLabel: 'process_high' {
                cpus   = 4
                memory = 8.GB
                time   = 2.h
            }
        }
    }

    shipboard {
        process.executor = 'local'
        executor {
            cpus   = 32
            memory = '256 GB'
        }
        params {
            assembly_cpus   = 32
            assembly_memory = '128 GB'
        }
    }
}

// ============================================================================
// Reports and tracing
// ============================================================================

timeline {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/timeline.html"
    overwrite = true
}

report {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/report.html"
    overwrite = true
}

trace {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/trace.txt"
    overwrite = true
    fields    = 'task_id,hash,native_id,process,tag,name,status,exit,submit,start,complete,duration,realtime,%cpu,%mem,rss,peak_rss'
}

dag {
    enabled   = true
    file      = "${params.outdir}/pipeline_info/dag.html"
    overwrite = true
}

// ============================================================================
// Manifest
// ============================================================================

manifest {
    name            = 'dana-mag-assembly'
    author          = 'Dana Pipeline'
    description     = 'MAG assembly and binning pipeline for Nanopore metagenomics'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version         = '1.0.0'
}
